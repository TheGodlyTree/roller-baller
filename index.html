<!DOCTYPE html>
<html lang="en-us">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity WebGL Player | Roller Baller</title>
    <base href="https://cdn.jsdelivr.net/gh/bubbls/UGS-Assets@main/roller%20baller/">
    
    <style>
        body { margin: 0; background-color: #333; overflow: hidden; }
        #unityContainer { 
            width: 100vw !important; 
            height: 100vh !important; 
            background-color: #231F20; 
        }
        /* Loading Overlay */
        #loadingBox {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 200px;
        }
        #spinner {
            height: 4px;
            width: 100%;
            background-color: #FFF;
            position: relative;
            overflow: hidden;
            border-radius: 2px;
        }
        #spinner::before {
            content: "";
            position: absolute;
            left: -150px;
            width: 150px;
            height: 100%;
            background-color: #990000;
            animation: loading 2s linear infinite;
        }
        @keyframes loading {
            0% { left: -100%; }
            100% { left: 100%; }
        }
        p#loadingInfo {
            color: #FFF;
            font-family: sans-serif;
            font-size: 10px;
            margin-top: 10px;
            text-transform: uppercase;
        }
    </style>

    <script src="Build/UnityLoader.js"></script>
    <script>
        window.mergedBlobUrls = {};
        window.assetsReady = false;

        async function mergeSplitFile(fileUrlBase, numParts = 2) {
            const partUrls = Array.from({ length: numParts }, (_, i) => `${fileUrlBase}.part${i + 1}`);
            try {
                const responses = await Promise.all(partUrls.map(url => fetch(url)));
                if (responses.some(r => !r.ok)) return null;
                const parts = await Promise.all(responses.map(r => r.arrayBuffer()));
                const combinedBlob = new Blob(parts, { type: 'application/octet-stream' });
                return URL.createObjectURL(combinedBlob);
            } catch (error) {
                console.error("Error merging files:", error);
                return null;
            }
        }

        function setupXHRInterceptor() {
            if (window.xhrInterceptorInstalled) return;
            const originalOpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url, ...args) {
                let finalUrl = url;
                for (const [filename, blobUrl] of Object.entries(window.mergedBlobUrls)) {
                    if (url.includes(filename)) {
                        finalUrl = blobUrl;
                        break;
                    }
                }
                return originalOpen.call(this, method, finalUrl, ...args);
            };
            window.xhrInterceptorInstalled = true;
        }

        async function prepareGameAssets() {
            setupXHRInterceptor();
            
            // Merging the main data file
            const dataFile = 'Build/RollerBallerRelease.data.unityweb';
            const blobUrl = await mergeSplitFile(dataFile, 2);
            
            if (blobUrl) {
                window.mergedBlobUrls[dataFile] = blobUrl;
            }

            window.assetsReady = true;
            
            // Initialize Unity
            const unityInstance = UnityLoader.instantiate(
                "unityContainer", 
                "Build/RollerBallerRelease.json", 
                { onProgress: UnityProgress }
            );
        }

        // Custom Progress Handler
        function UnityProgress(unityInstance, progress) {
            if (!unityInstance.Module) return;
            const loadingBox = document.getElementById("loadingBox");
            if (progress === 1) {
                loadingBox.style.display = "none";
            }
        }

        window.onload = prepareGameAssets;
    </script>
</head>
<body>
    <div id="unityContainer"></div>
    <div id="loadingBox">
        <div id="spinner"></div>
        <p id="loadingInfo">Loading Assets...</p>
    </div>
</body>
</html>
